---
sidebar_position: 4
---

# Ruby

The [Ruby](https://www.ruby-lang.org/) interpreter is not embedded in Wasm Workers Server. To create workers based on this language, you first need to install a Ruby runtime.

Fortunately, we provide precompiled `ruby.wasm` modules in our [WebAssembly Language Runtimes](https://github.com/vmware-labs/webassembly-language-runtimes/) project, so the installation is simple.

## Run a Ruby example

1. Download `wws`:

    ```bash
    curl -fsSL https://workers.wasmlabs.dev/install | bash
    ```

2. Run the [ruby-basic](https://github.com/vmware-labs/wasm-workers-server/tree/main/examples/ruby-basic) example from the Wasm Workers Server's repository. The `-i` flag will install the Ruby runtime automatically.

    ```bash
    wws https://github.com/vmware-labs/wasm-workers-server.git -i --git-folder "examples/ruby-basic"
    ```

3. Access to <a href="http://localhost:8080/" target="_blank">http://localhost:8080</a>.

## Ruby runtime installation

To install the Ruby Wasm module, run the following command:

```console
wws runtimes install ruby latest
```

## Your first Ruby worker

Ruby workers are based on the [Request](https://developer.mozilla.org/en-US/docs/Web/API/Request) / [Response](https://developer.mozilla.org/en-US/docs/Web/API/Response) objects from the Web Fetch API. Since these entities don't exist in the Ruby language, the worker includes a polyfill with these two classes. You can find the [polyfill code here](https://github.com/vmware-labs/wasm-workers-server/blob/main/metadata/repository/v1/files/ruby/3/poly.rb).

In this example, the worker will get a request and print all the related information.

1. First, create a new `index.rb` file with the following content. The `worker` method is mandatory as it will be the entrypoint for the worker:

    ```ruby title="./index.rb"
    def worker(req)
        Response.new("Hello from Ruby in WebAssembly!")
    end
    ```

1. Now, you can add more content to the `worker` method to show the request information. In addition to that, let's add a response header.

    ```ruby title="./index.rb"
    def worker(req)
        # Body response
        body = %{
            <!DOCTYPE html>
            <body>
            <h1>Hello from Wasm Workers Server</h1>
            <p>Replying to #{req.url}</p>
            <p>Method: #{req.method}</p>
            <p>User Agent: #{req.headers["user-agent"]}</p
            <p>Payload: #{req.body || "-"}</p>
            <p>
                This page was generated by a Ruby file inside WebAssembly
            </p>
            </body>
        }

        # Build a new response
        res = Response.new(body)

        # Add a new header
        res.headers["x-generated-by"] = "wasm-workers-server"

        res
    end
    ```

1. Save the file
1. If you didn't download the `wws` server yet, check our [Getting Started](../get-started/quickstart.md) guide.
1. [Install the Ruby runtime](#installation)
1. Run your worker with `wws`

    ```bash
    wws

    ‚öôÔ∏è Loading routes from: .
    üó∫ Detected routes:
        - http://127.0.0.1:8080/
        => index.rb (name: default)
    üöÄ Start serving requests at http://127.0.0.1:8080
    ```

1. Finally, open <http://127.0.0.1:8080> in your browser.

## Add a Key / Value store

Wasm Workers allows you to add a Key / Value store to your workers. Read more information about this feature in the [Key / Value store](../features/key-value.md) section.

To add a KV store to your worker, follow these steps:

1. First, create a `counter.rb` file. It will access the KV store through the `Cache` object:

    ```ruby title="./counter.rb"
    CACHE_KEY = "counter";

    def worker(request)
        # Prepare the body
        count = Cache.get(CACHE_KEY).to_i || 0
        body = "The counter value is: #{count}"

        # Update the counter
        count += 1
        Cache.set(CACHE_KEY, count)

        # Return the response
        Response.new(body)
    end
    ```

1. Create a `counter.toml` file with the following content. Note the name of the TOML file must match the name of the worker. In this case we have `counter.rb` and `counter.toml` in the same folder:

    ```toml title="./counter.toml"
    name = "counter"
    version = "1"

    [data]
    [data.kv]
    namespace = "counter"
    ```

1. If you didn't download the `wws` server yet, check our [Getting Started](../get-started/quickstart.md) guide. You also need to install the Ruby runtime with the command below:

    ```plain
    wws runtimes install ruby latest
    ```

1. Save the file and run your worker with `wws`:

    ```bash
    wws

    ‚öôÔ∏è Loading routes from: .
    üó∫ Detected routes:
        - http://127.0.0.1:8080/counter
        => counter.rb (name: default)
    üöÄ Start serving requests at http://127.0.0.1:8080
    ```

1. Finally, open <http://127.0.0.1:8080/counter> in your browser.

## Dynamic routes

You can define [dynamic routes by adding route parameters to your worker files](../features/dynamic-routes.md) (like `[id].rb`). To read them in Ruby, access to the `request.params` object:

```rb
def worker(request)
    Response.new("The URL parameter is: #{request.params['id']}")
end
```

## Read environment variables

Environment variables are configured [via the related TOML configuration file](../features/environment-variables.md). These variables are directly injected as global constants in your worker. To read them, just use the same name you configured in your TOML file:

```toml title="./envs.toml"
name = "envs"
version = "1"

[vars]
MESSAGE = "Hello üëã! This message comes from an environment variable"
```

Now, you can read the `MESSAGE` environment variable using the Ruby `ENV` class:

```ruby title="./envs.rb"
def worker(request)
    Response.new(
        "The environment variable value is: #{ENV.fetch('MESSAGE')}"
    )
end
```

If you prefer, you can configure the environment variable value dynamically by following [these instructions](../features/environment-variables.md#inject-existing-environment-variables).

## Examples

* [Basic](https://github.com/vmware-labs/wasm-workers-server/tree/main/examples/ruby-basic/)
* [Key / Value](https://github.com/vmware-labs/wasm-workers-server/tree/main/examples/ruby-kv/)
* [Environment variables](https://github.com/vmware-labs/wasm-workers-server/tree/main/examples/ruby-envs/)

## Feature compatibility

[Workers' features](../features/all.md) that are available in Ruby:

| [K/V Store](../features/key-value.md) | [Environment Variables](../features/environment-variables.md) | [Dynamic Routes](../features/dynamic-routes.md) | [Folders](../features/mount-folders.md) | [HTTP Requests](../features/http-requests.md) |
| --- | --- | --- | --- | --- |
|  ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
